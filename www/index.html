<!DOCTYPE html>
<!-- saved from url=(0040)https://raysfiles.com/og/og_devices.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGarage Web App</title>
    <style>
        :root {
            --primary-color: #5994bd;
            --secondary-color: #2c3e50;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --danger-color-dark: #c0392b;
            --warning-color: #f39c12;
            --bg-color: #f4f7f6;
            --font-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--font-color);
            -webkit-tap-highlight-color: transparent;
        }

        /* Page Layout */
        .page {
            display: none;
            flex-direction: column;
            min-height: 100vh;
        }
        .page.active {
            display: flex;
        }

        .header {
            background-color: var(--secondary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        .header .header-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: background-color 0.2s;
        }
        .header .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .content {
            padding: 1rem 0.5rem;
            flex-grow: 1;
        }

        .footer {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 0.9rem;
            border-top: 1px solid var(--medium-gray);
        }

        #page_devices .footer {
            background: none;
            border: none;
            padding: 0;
            margin-top: 1.5rem;
        }

        #page_devices .footer hr {
            border: 0;
            border-top: 1px solid var(--medium-gray);
            margin: 0;
        }

        #page_devices .footer p {
            margin: 0.5rem 0 0 0;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            table-layout: auto;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        th {
            background-color: var(--light-gray);
            font-weight: bold;
            text-align: center;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr.selected td {
            background-color: #fef08a;
        }
        td:first-child {
            font-weight: bold;
        }

        #tab_devlist {
            width: auto;
            margin: 0;
        }

        /* Buttons & Controls */
        .main-button-container {
            max-width: 400px;
        }
        .control-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .control-group .btn {
            flex: 0 1 100px;
        }
        .btn {
            padding: 0.75rem 0.75rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2471a3;
        }
        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--secondary-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--dark-gray);
            color: white;
        }
        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: var(--danger-color-dark);
        }
        .btn:disabled {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            opacity: 0.4;
            border-color: var(--light-gray);
        }

        /* Add Device Menu */
        #dev_addmenu {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 220px;
            overflow: hidden;
        }
        #dev_addmenu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--secondary-color);
            text-decoration: none;
            border-bottom: 1px solid var(--light-gray);
        }
        #dev_addmenu a:hover {
            background-color: var(--light-gray);
        }
        #dev_addmenu li:last-child a {
            border-bottom: none;
        }

        /* Modal / Popup */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
        }
        #confirm_message {
            margin: 0 0 1.5rem 0;
            font-size: 1.1rem;
            line-height: 1.5;
            text-align: center;
        }

        /* Form Elements */
        .form-field {
            margin-bottom: 1rem;
        }
        .form-field label, .form-field b {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="text"], input[type="password"], input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1rem;
        }
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .message-label {
            min-height: 1.2em;
            margin: 0.5rem 0;
        }

        /* Specific Page Styles */
        #page_devices .content > b {
            font-size: 1.1rem;
        }
        .smallfont {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        #page_currdev .content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .currdev-status-table {
            font-size: 1.25rem;
            width: 100%;
            max-width: 400px;
            margin-bottom: 2rem;
        }

        #currdev-btn {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            border: 5px solid white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        #currdev-btn.open {
            background: linear-gradient(145deg, #e85a4f, #d84315);
        }
        #currdev-btn.closed {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
        }
        #currdev-btn.opening {
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
        }
        #currdev-btn.stopped {
            background: linear-gradient(145deg, #f1c40f, #f39c12);
        }
        #currdev-btn.closing {
            background: linear-gradient(145deg, #3498db, #2980b9);
        }

        #btn_dev_home {
            margin-top: 2rem;
        }
    </style>
</head>
<body>

<!-- PAGE: Device List -->
<div class="page active" id="page_devices">
    <div class="header"><h3>OpenGarage Web App v1.1</h3></div>
    <div class="content">
        <table id="tab_devlist">
            <thead>
                <tr><th>Device Name</th><th>Door</th><th>Car</th><th>Dist.</th></tr>
            </thead>
            <tbody>
                <!-- Device rows will be injected here -->
            </tbody>
        </table>
        <br>
        <b>Selected</b>: <span id="lb_sel_msg">-</span><br>
        <span class="smallfont">(Click a device name to select/unselect it)</span>
        <br><br>
        <div class="main-button-container">
            <div class="control-group">
                <button class="btn btn-secondary clbtnmod" id="btn_dev_del" disabled="">‚ùå Delete</button>
                <button class="btn btn-secondary clbtnmod" id="btn_dev_up" disabled="">Move ‚¨Ü</button>
                <button class="btn btn-secondary clbtnmod" id="btn_dev_down" disabled="">Move ‚¨á</button>
            </div>
            <div class="control-group">
                <button class="btn btn-primary" id="btn_dev_add">‚úì Add</button>
                <button class="btn btn-primary clbtnmod" id="btn_dev_click" disabled="">ü´µ Click</button>
                <button class="btn btn-primary clbtnmod" id="btn_dev_got" disabled="">Go to ‚û°</button>
            </div>
        </div>
        <ul id="dev_addmenu" style="display:none;">
            <li><a href="https://raysfiles.com/og/og_devices.html#" id="btn_dev_add_by_ip">by IP</a></li>
            <li><a href="https://raysfiles.com/og/og_devices.html#" id="btn_dev_add_by_blynk">by Blynk token</a></li>
            <li><a href="https://raysfiles.com/og/og_devices.html#" id="btn_dev_add_by_otc">by OTC token</a></li>
        </ul>
        <div class="footer">
            <hr>
            <p>Number of devices: <label id="ndevs">0</label></p>
        </div>
    </div>
</div>

<!-- PAGE: Current Device -->
<div class="page" id="page_currdev">
    <div class="header" id="name_curr">
        <button class="header-btn" id="btn_dev_list">‚¨Ö List</button>
        <h3>OpenGarage</h3>
    </div>
    <div class="content">
        <table class="currdev-status-table">
            <tbody>
                <tr><td><b>Door:</b></td><td id="door_curr">(offline)</td></tr>
                <tr><td><b>Car:</b></td><td id="car_curr">-</td></tr>
                <tr><td><b>Dist:</b></td><td id="dist_curr">-</td></tr>
            </tbody>
        </table>
        <button id="currdev-btn" class="btn" disabled="">Click</button>
        <button class="btn btn-secondary" id="btn_dev_home" disabled="">Device Homepage ‚û°</button>
    </div>
    <div class="footer">
        <p>This device: <label id="lbl_currdev">-</label></p>
    </div>
</div>

<!-- MODAL: Add Device -->
<div id="popup_dev_add" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" id="btn_dev_add_close">√ó</button>
        <div class="modal-header">
            <h3>Add A New Device</h3>
        </div>
        <div class="modal-body">
            <div class="form-field daip">
                <b>IP or domain name:</b>
                <input type="text" id="da_ip" placeholder="192.168.0.15">
            </div>
            <div class="form-field daip">
                <b>Device key:</b>
                <input type="password" id="da_devkey">
            </div>
            <div class="form-field dacld">
                <b><label id="lb_cld_token"></label> Token:</b>
                <input type="text" id="da_token">
            </div>
            <div class="form-field dacld">
                <b><label id="lb_cld_server"></label> Server:</b>
                <input type="text" id="da_server">
            </div>
            <div class="form-field dacld">
                <b>Port:</b>
                <input type="number" id="da_port">
            </div>
            <div class="message-label" id="lb_da_msg"></div>
            <div class="control-group">
                <button id="btn_dev_add_cancel" class="btn btn-secondary dabtn">Cancel</button>
                <button id="btn_dev_add_submit" class="btn btn-primary dabtn">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Confirmation -->
<div id="popup_confirm" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="confirm_title">Are you sure?</h3>
        </div>
        <div class="modal-body">
            <p id="confirm_message"></p>
            <div class="control-group">
                <button id="btn_confirm_cancel" class="btn btn-secondary">Cancel</button>
                <button id="btn_confirm_ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- State Variables ---
    const og_devices_localStorage_name = 'og_devices_v1';
    let devlist = [];
    let currdev = -1;
    let dev_add_by = '';
    let selected = -1;
    let config_currdev = null;
    let tm_devices = null;
    let tm_currdev = null;

    // --- DOM Element References ---
    const pages = document.querySelectorAll('.page');
    const pageDevices = document.getElementById('page_devices');
    const pageCurrDev = document.getElementById('page_currdev');

    // --- Helper Functions ---
    const showPage = (pageId) => {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    };

    const showMsg = (selector, msg, duration = 0, color = 'black') => {
        const el = document.querySelector(selector);
        if (el) {
            el.textContent = msg;
            el.style.color = color;
            if (duration > 0) {
                setTimeout(() => { el.textContent = ''; }, duration);
            }
        }
    };
    const clearMsg = (selector) => showMsg(selector, '');

    const save_localStorage = () => {
        const og_devices = { 'currdev': currdev, 'devlist': devlist };
        localStorage.setItem(og_devices_localStorage_name, JSON.stringify(og_devices));
    };

    const load_localStorage = () => {
        const store = localStorage.getItem(og_devices_localStorage_name);
        if (store) {
            try {
                const og_devices = JSON.parse(store);
                devlist = og_devices.devlist || [];
                currdev = og_devices.currdev || -1;
                sync_table_to_devlist();
            } catch (e) {
                console.error("Error parsing localStorage data", e);
                devlist = [];
                currdev = -1;
            }
        }
        document.getElementById('ndevs').textContent = devlist.length;
    };

    // --- Confirmation Modal Logic ---
    const confirmModal = document.getElementById('popup_confirm');
    const confirmMessageEl = document.getElementById('confirm_message');
    const confirmTitleEl = document.getElementById('confirm_title');
    let confirmOkBtn = document.getElementById('btn_confirm_ok');
    let confirmCancelBtn = document.getElementById('btn_confirm_cancel');

    const showConfirmation = (message, onConfirm, options = {}) => {
        confirmMessageEl.textContent = message;
        confirmTitleEl.textContent = options.title || 'Are you sure?';

        // Use cloneNode to remove old event listeners
        let newOkBtn = confirmOkBtn.cloneNode(true);
        confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
        confirmOkBtn = newOkBtn; // Update reference to the new button

        let newCancelBtn = confirmCancelBtn.cloneNode(true);
        confirmCancelBtn.parentNode.replaceChild(newCancelBtn, confirmCancelBtn);
        confirmCancelBtn = newCancelBtn; // Update reference to the new button

        // Set button styles on the new button
        confirmOkBtn.className = 'btn';
        confirmOkBtn.classList.add(options.okClass || 'btn-primary');
        confirmOkBtn.textContent = options.okText || 'OK';

        const closeConfirm = () => confirmModal.classList.remove('visible');

        confirmOkBtn.addEventListener('click', () => {
            closeConfirm();
            onConfirm();
        });

        confirmCancelBtn.addEventListener('click', closeConfirm);

        confirmModal.classList.add('visible');
    };


    // --- UI Update Functions ---
    const door2str = (d) => {
        const status = {
            0: 'closed', 1: 'OPEN', 2: 'Stopped', 3: 'closing',
            4: 'OPENING', 5: '(unknown)'
        };
        return status[d] || '(offline)';
    };

    const car2str = (c) => {
        if (c === 0 || c === '0') return 'vacant';
        if (c === 1 || c === '1') return 'parked';
        return '-';
    };

    const conf2str_short = (c) => {
        if (c.type === 'ip') return `ip (${c.ip})`;
        return `${c.type} (${c.token.slice(0, 4)}...${c.token.slice(-4)}@${c.server})`;
    };

    const update_lb_sel_msg = () => {
        const msgEl = document.getElementById('lb_sel_msg');
        msgEl.textContent = selected === -1 ? '-' : conf2str_short(devlist[selected]);
    };

    const updateControlButtons = () => {
        const isSelected = selected >= 0;
        document.querySelectorAll('.clbtnmod').forEach(btn => {
            btn.disabled = !isSelected;
        });
        if (isSelected) {
            document.getElementById('btn_dev_click').disabled = devlist[selected].door === -1;
            document.getElementById('btn_dev_up').disabled = selected < 1;
            document.getElementById('btn_dev_down').disabled = selected >= devlist.length - 1;
        }
    };

    const select_tr = (id) => {
        const prevSelected = selected;

        // Un-highlight previous
        if (prevSelected >= 0) {
            const prevRow = document.getElementById(`dev${prevSelected}`);
            if (prevRow) prevRow.classList.remove('selected');
        }

        if (prevSelected === id) {
            selected = -1; // Deselect
        } else {
            selected = id;
            const newRow = document.getElementById(`dev${id}`);
            if (newRow) newRow.classList.add('selected');
        }
        updateControlButtons();
        update_lb_sel_msg();
    };

    const sync_table_to_devlist = () => {
        const tbody = document.querySelector('#tab_devlist tbody');
        tbody.innerHTML = '';
        devlist.forEach((config, i) => {
            const r = document.createElement('tr');
            r.id = `dev${i}`;
            r.innerHTML = `
                <td id="name${i}">${config.name}</td>
                <td id="door${i}"></td>
                <td id="car${i}"></td>
                <td id="dist${i}"></td>
            `;
            // Add click listener to the whole row for selection
            r.addEventListener('click', () => select_tr(i));
            // Add click listener to door status for action
            r.querySelector(`#door${i}`).addEventListener('click', (e) => {
                e.stopPropagation(); // prevent row selection event
                if (selected === i) {
                    document.getElementById('btn_dev_click').click();
                }
            });
            tbody.appendChild(r);
        });
        update_tr(0, devlist.length);
        if(selected >= devlist.length) selected = -1;
        if(selected > -1) {
             const selectedRow = document.getElementById(`dev${selected}`);
             if(selectedRow) selectedRow.classList.add('selected');
        }
        updateControlButtons();
        update_lb_sel_msg();
    };

    const update_tr = (start, n) => {
        for (let i = start; i < start + n; i++) {
            const d = devlist[i];
            document.getElementById(`name${i}`).textContent = d.name;
            if (d.door === -1) {
                document.getElementById(`door${i}`).textContent = '(offline)';
                document.getElementById(`car${i}`).textContent = '-';
                document.getElementById(`dist${i}`).textContent = '-';
            } else {
                document.getElementById(`door${i}`).textContent = door2str(d.door);
                document.getElementById(`car${i}`).textContent = car2str(d.car);
                document.getElementById(`dist${i}`).textContent = d.dist;
            }
        }
    };

    const update_tr_currdev = () => {
        const d = config_currdev;
        document.querySelector('#name_curr h3').textContent = d.name;
        const btn = document.getElementById('currdev-btn');

        if (d.door === -1) {
            document.getElementById('door_curr').textContent = '(offline)';
            document.getElementById('car_curr').textContent = '-';
            document.getElementById('dist_curr').textContent = '-';
            btn.disabled = true;
            btn.textContent = 'Click';
            btn.className = 'btn'; // Reset classes
        } else {
            document.getElementById('door_curr').textContent = door2str(d.door);
            document.getElementById('car_curr').textContent = car2str(d.car);
            document.getElementById('dist_curr').textContent = d.dist;
            btn.disabled = false;

            // Reset all state classes first
            btn.classList.remove('open', 'closed', 'opening', 'stopped', 'closing');

            switch (d.door) {
                case 0: // closed
                    btn.textContent = 'Open';
                    btn.classList.add('closed');
                    break;
                case 1: // OPEN
                    btn.textContent = 'Close';
                    btn.classList.add('open');
                    break;
                case 2: // Stopped
                    btn.textContent = 'Click';
                    btn.classList.add('stopped');
                    break;
                case 3: // closing
                    btn.textContent = 'Click';
                    btn.classList.add('closing');
                    break;
                case 4: // OPENING
                    btn.textContent = 'Click';
                    btn.classList.add('opening');
                    break;
                default: // unknown or other states
                    btn.textContent = 'Click';
                    break;
            }
        }
    };

    // --- Device Communication ---
    const connect_device = async (config, dtype, success_cb, fail_cb, devid = -1, endpoint = '') => {
        let comm;
        if (config.type === 'ip') {
            comm = `http://${config.ip}${endpoint || '/jc'}`;
        } else if (config.type === 'blynk') {
            const protocol = (config.server === 'blynk-cloud.com' || config.port == 80) ? 'http://' : 'https://';
            comm = `${protocol}${config.server}:${config.port}/${config.token}${endpoint || '/project'}`;
        } else if (config.type === 'otc') {
            comm = `https://${config.server}:${config.port || 443}/forward/v1/${config.token}${endpoint || '/jc'}`;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        try {
            const response = await fetch(comm, { signal: controller.signal });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const result = dtype.toLowerCase() === 'json' ? await response.json() : await response.text();
            success_cb(result, devid);
        } catch (error) {
            console.error('Connection failed:', error);
            fail_cb(devid);
        } finally {
            clearTimeout(timeoutId);
        }
    };

    const find_virtual_pin_value = (r, pin) => {
        if (!r.widgets) return -1;
        const widget = r.widgets.find(w => w.pin === pin);
        return widget ? widget.value : -1;
    };

    // --- Status Update Loops ---
    const update_status = async () => {
        for (let i = 0; i < devlist.length; i++) {
            const config = devlist[i];
            let skip = false;

            if (config.type === 'blynk') {
                await new Promise(resolve => {
                    connect_device(config, 'text',
                        (r) => { if (r === 'false') skip = true; resolve(); },
                        () => { skip = true; resolve(); },
                        i, '/isHardwareConnected'
                    );
                });

                if (skip && devlist[i].door !== -1) {
                    devlist[i].door = -1;
                    update_tr(i, 1);
                    save_localStorage();
                    updateControlButtons();
                }
            }

            if (skip) continue;

            connect_device(config, 'JSON', (r, id) => {
                let dirty = false;
                let door = -1, car, dist, name;
                if (devlist[id].type === 'blynk') {
                    name = r.name;
                    door = parseInt(find_virtual_pin_value(r, 0)) === 0 ? 0 : 1;
                    dist = parseInt(find_virtual_pin_value(r, 3));
                    car = parseInt(find_virtual_pin_value(r, 4)) === 0 ? 0 : 1;
                } else {
                    ({ door, vehicle: car, dist, name } = r);
                }

                if (devlist[id].door != door) { devlist[id].door = door; dirty = true; }
                if (devlist[id].car != car) { devlist[id].car = car; dirty = true; }
                if (devlist[id].dist != dist) { devlist[id].dist = dist; dirty = true; }
                if (devlist[id].name != name) { devlist[id].name = name; dirty = true; }

                if (dirty) {
                    update_tr(id, 1);
                    save_localStorage();
                    if (selected === id) updateControlButtons();
                }
            }, (id) => {
                if (devlist[id].door !== -1) {
                    devlist[id].door = -1;
                    update_tr(id, 1);
                    save_localStorage();
                    if (selected === id) updateControlButtons();
                }
            }, i);
        }
    };

    const update_status_currdev = async () => {
        if (!config_currdev) return;
        let skip = false;

        if (config_currdev.type === 'blynk') {
            await new Promise(resolve => {
                 connect_device(config_currdev, 'text',
                    (r) => { if (r === 'false') skip = true; resolve(); },
                    () => { skip = true; resolve(); },
                    -1, '/isHardwareConnected'
                );
            });
            if (skip && config_currdev.door !== -1) {
                config_currdev.door = -1;
                update_tr_currdev();
            }
        }

        if (skip) return;

        connect_device(config_currdev, 'JSON', (r) => {
             let dirty = false;
             let door = -1, car, dist, name;
             if (config_currdev.type === 'blynk') {
                 name = r.name;
                 door = parseInt(find_virtual_pin_value(r, 0)) === 0 ? 0 : 1;
                 dist = parseInt(find_virtual_pin_value(r, 3));
                 car = parseInt(find_virtual_pin_value(r, 4)) === 0 ? 0 : 1;
             } else {
                 ({ door, vehicle: car, dist, name } = r);
             }

             if (config_currdev.door != door) { config_currdev.door = door; dirty = true; }
             if (config_currdev.car != car) { config_currdev.car = car; dirty = true; }
             if (config_currdev.dist != dist) { config_currdev.dist = dist; dirty = true; }
             if (config_currdev.name != name) { config_currdev.name = name; dirty = true; }

             if (dirty) update_tr_currdev();
        }, () => {
             if (config_currdev.door !== -1) {
                 config_currdev.door = -1;
                 update_tr_currdev();
             }
        }, -1);
    };

    // --- Click Handlers & Event Listeners ---
    document.getElementById('btn_dev_del').addEventListener('click', () => {
        if (selected < 0) return;
        showConfirmation(
            'This will permanently delete the selected device.',
            () => {
                devlist.splice(selected, 1);
                document.getElementById('ndevs').textContent = devlist.length;
                const currentSelected = selected;
                selected = -1;
                sync_table_to_devlist();
                save_localStorage();
                if (currentSelected > 0) {
                    select_tr(currentSelected - 1);
                } else {
                    select_tr(-1);
                }
            },
            {
                title: 'Delete Device?',
                okText: 'Delete',
                okClass: 'btn-danger'
            }
        );
    });

    const swap_dev = (i, j) => {
        [devlist[i], devlist[j]] = [devlist[j], devlist[i]];
        save_localStorage();
    };

    document.getElementById('btn_dev_up').addEventListener('click', () => {
        if (selected < 1) return;
        swap_dev(selected, selected - 1);
        sync_table_to_devlist();
        select_tr(selected - 1);
    });

    document.getElementById('btn_dev_down').addEventListener('click', () => {
        if (selected < 0 || selected >= devlist.length - 1) return;
        swap_dev(selected, selected + 1);
        sync_table_to_devlist();
        select_tr(selected + 1);
    });

    document.getElementById('btn_dev_got').addEventListener('click', () => {
        if (selected < 0 || selected >= devlist.length) return;
        currdev = selected;
        save_localStorage();
        showPage('page_currdev');
        handlePageCurrDevShow();
    });

    const perform_btn_click = (config) => {
        if (config.door === -1) return;
        showConfirmation(
            'The door will start moving. Are you sure?',
            () => {
                let endpoint;
                if (config.type === 'blynk') {
                    endpoint = '/update/V1?value=1';
                    connect_device(config, 'text',
                        () => setTimeout(() => {
                            connect_device(config, 'text', () => {}, () => {}, -1, '/update/V1?value=0');
                        }, 500),
                        () => alert('Request failed!'), -1, endpoint);
                } else {
                    endpoint = (config.type === 'ip') ? `/cc?dkey=${config.devkey}&click=1` : '/cc?click=1';
                    connect_device(config, 'JSON', (result) => {
                        if (result.result === 1) return;
                        alert(result.result === 2 ? 'Incorrect device key!' : JSON.stringify(result));
                    }, () => alert('Request failed!'), -1, endpoint);
                }
            },
            {
                title: 'Confirm Action',
                okText: 'Confirm'
            }
        );
    };

    document.getElementById('btn_dev_click').addEventListener('click', () => {
        if (selected < 0) return;
        perform_btn_click(devlist[selected]);
    });

    document.getElementById('currdev-btn').addEventListener('click', () => {
        perform_btn_click(config_currdev);
    });

    document.getElementById('btn_dev_list').addEventListener('click', () => {
        currdev = -1;
        config_currdev = null;
        save_localStorage();
        showPage('page_devices');
        handlePageDevicesShow();
    });

    document.getElementById('btn_dev_home').addEventListener('click', () => {
        let url;
        const c = config_currdev;
        if (c.type === 'ip') url = `http://${c.ip}`;
        else if (c.type === 'otc') url = `https://${c.server}:${c.port}/forward/v1/${c.token}`;
        else return;
        window.open(url, '_blank');
    });

    // --- Add Device Modal Logic ---
    const modal = document.getElementById('popup_dev_add');
    const openModal = () => modal.classList.add('visible');
    const closeModal = () => modal.classList.remove('visible');

    document.getElementById('btn_dev_add').addEventListener('click', (e) => {
        e.preventDefault();
        const menu = document.getElementById('dev_addmenu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    });

    document.getElementById('btn_dev_add_close').addEventListener('click', closeModal);
    document.getElementById('btn_dev_add_cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    const clear_da_fields = () => {
        document.getElementById('da_ip').value = '';
        document.getElementById('da_devkey').value = '';
        document.getElementById('da_token').value = '';
        document.getElementById('da_server').value = '';
        document.getElementById('da_port').value = '';
        clearMsg('#lb_da_msg');
    };

    const setupAddModal = (type) => {
        dev_add_by = type;
        const isIp = type === 'ip';
        document.querySelectorAll('.daip').forEach(el => el.style.display = isIp ? 'block' : 'none');
        document.querySelectorAll('.dacld').forEach(el => el.style.display = isIp ? 'none' : 'block');

        clear_da_fields();

        if(type === 'blynk') {
            document.getElementById('lb_cld_token').textContent = 'Blynk';
            document.getElementById('lb_cld_server').textContent = 'Blynk';
            document.getElementById('da_server').value = 'blynk.openthings.io';
            document.getElementById('da_port').value = 9443;
        } else if (type === 'otc') {
            document.getElementById('lb_cld_token').textContent = 'OTC';
            document.getElementById('lb_cld_server').textContent = 'OTC';
            document.getElementById('da_server').value = 'cloud.openthings.io';
            document.getElementById('da_port').value = 443;
        }

        document.getElementById('dev_addmenu').style.display = 'none';
        openModal();
    };

    document.getElementById('btn_dev_add_by_ip').addEventListener('click', (e) => { e.preventDefault(); setupAddModal('ip'); });
    document.getElementById('btn_dev_add_by_blynk').addEventListener('click', (e) => { e.preventDefault(); setupAddModal('blynk'); });
    document.getElementById('btn_dev_add_by_otc').addEventListener('click', (e) => { e.preventDefault(); setupAddModal('otc'); });

    document.getElementById('btn_dev_add_submit').addEventListener('click', () => {
        let config;
        if (dev_add_by === 'ip') {
            const ip = document.getElementById('da_ip').value.trim();
            if (!ip) return alert('Invalid IP!');
            const devkey = document.getElementById('da_devkey').value;
            if (!devkey && !confirm('Device key is empty, are you sure?')) return;
            config = { 'ip': ip, 'devkey': devkey };
        } else if (dev_add_by === 'blynk' || dev_add_by === 'otc') {
            const token = document.getElementById('da_token').value.trim();
            if (token.length < 32) return alert('Invalid token length!');
            const server = document.getElementById('da_server').value.trim();
            if (!server) return alert('Invalid server!');
            const port = parseInt(document.getElementById('da_port').value, 10);
            if (isNaN(port) || port < 1 || port > 65535) return alert('Invalid port!');
            config = { 'token': token, 'server': server, 'port': port };
        } else {
            return alert('Invalid add method');
        }

        Object.assign(config, { type: dev_add_by, name: 'OG', door: -1, car: -1, dist: -1 });

        showMsg('#lb_da_msg', 'Connecting...', 0, 'green');
        document.querySelectorAll('.dabtn').forEach(b => b.disabled = true);

        const add_new_dev = (conf) => {
            devlist.push(conf);
            save_localStorage();
            document.getElementById('ndevs').textContent = devlist.length;
            sync_table_to_devlist();
            update_tr(devlist.length - 1, 1);
            closeModal();
        };

        connect_device(config, 'JSON', (result) => {
            if (typeof result.name === 'string') {
                config.name = result.name;
            }
            add_new_dev(config);
        }, () => {
            if (confirm('Failed to connect. Add device anyway?')) {
                add_new_dev(config);
            }
        }, -1, (config.type === 'blynk' ? '/project' : '/jc'))
        .finally(() => {
            document.querySelectorAll('.dabtn').forEach(b => b.disabled = false);
            clearMsg('#lb_da_msg');
        });
    });

    // --- Page Change Logic ---
    const handlePageDevicesShow = () => {
        if (tm_currdev) { clearInterval(tm_currdev); tm_currdev = null; }
        setTimeout(update_status, 100);
        tm_devices = setInterval(update_status, 5000);
    };

    const handlePageCurrDevShow = () => {
        if (currdev < 0 || currdev >= devlist.length) {
            // Invalid state, go back to list
            showPage('page_devices');
            handlePageDevicesShow();
            return;
        }
        if (tm_devices) { clearInterval(tm_devices); tm_devices = null; }
        config_currdev = { ...devlist[currdev] }; // Make a copy
        config_currdev.door = -1; // Force refresh

        document.getElementById('btn_dev_home').disabled = config_currdev.type === 'blynk';
        document.getElementById('lbl_currdev').textContent = conf2str_short(config_currdev);

        setTimeout(update_status_currdev, 100);
        tm_currdev = setInterval(update_status_currdev, 2000);
    };

    // --- Initialization ---
    load_localStorage();
    if (currdev < 0 || currdev >= devlist.length) {
        showPage('page_devices');
        handlePageDevicesShow();
    } else {
        showPage('page_currdev');
        handlePageCurrDevShow();
    }
});
</script>
<script defer="" src="js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;version&quot;:&quot;2024.11.0&quot;,&quot;token&quot;:&quot;fd31c820bc3048c5ae4c253709e3f2bf&quot;,&quot;r&quot;:1,&quot;server_timing&quot;:{&quot;name&quot;:{&quot;cfCacheStatus&quot;:true,&quot;cfEdge&quot;:true,&quot;cfExtPri&quot;:true,&quot;cfL4&quot;:true,&quot;cfOrigin&quot;:true,&quot;cfSpeedBrain&quot;:true},&quot;location_startswith&quot;:null}}" crossorigin="anonymous"></script>


</body></html>